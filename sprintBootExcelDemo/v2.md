å¾ˆå¥½ï¼Œä¸‹é¢æˆ‘ç›´æ¥çµ¦ä½ ä¸€å¥—**ä¼æ¥­ç´šã€å¯æ“´å……ã€çœŸå¯¦å°ˆæ¡ˆå¯ç”¨**çš„è¨­è¨ˆï¼Œä¸‰å€‹éœ€æ±‚ä¸€æ¬¡æ»¿è¶³ï¼š

âœ… **ExcelExportTemplateï¼ˆæ¨¡æ¿åŒ–ï¼‰**
âœ… **Annotation æ¨™è¨»æ¬„ä½ï¼ˆé›¶ POI ä¾µå…¥å•†æ¥­æ¨¡å‹ï¼‰**
âœ… **å¤š Sheet + å‹•æ…‹æ¬„ä½ï¼ˆå¯é–‹é—œã€å¯æ’åºï¼‰**

è€Œä¸”ç¬¦åˆé€™äº›åŸå‰‡ï¼š

* Controller / Business **å®Œå…¨ä¸çŸ¥é“ POI**
* åŒä¸€å¥— Template å¯åŒ¯å‡º **ä»»ä½• Entity**
* å¤§è³‡æ–™é‡å®‰å…¨ï¼ˆSXSSFï¼‰
* å¯æ¼”é€²æˆ CSV / PDF

---

# ä¸€ã€æœ€çµ‚æ¶æ§‹ï¼ˆä¼æ¥­ç´šï¼‰

```text
excel
â”œâ”€ annotation
â”‚  â””â”€ ExcelColumn.java
â”œâ”€ metadata
â”‚  â”œâ”€ ExcelColumnMeta.java
â”‚  â””â”€ ExcelSheetMeta.java
â”œâ”€ template
â”‚  â””â”€ ExcelExportTemplate.java
â”œâ”€ service
â”‚  â””â”€ ExcelExportService.java
â””â”€ util
   â””â”€ ExcelMetaResolver.java
```

---

# äºŒã€Annotationï¼šæ¬„ä½å®£å‘Šï¼ˆé—œéµï¼‰

```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ExcelColumn {

    String header();
    int order();
    boolean enabled() default true;
    String format() default "";
}
```

ğŸ“Œ **è¨­è¨ˆé‡é»**

* `order` â†’ æ¬„ä½é †åº
* `enabled` â†’ å‹•æ…‹é–‹é—œ
* `format` â†’ æ—¥æœŸ / é‡‘é¡æ ¼å¼

---

# ä¸‰ã€Entityï¼ˆå®Œå…¨ç„¡ POIï¼‰

```java
public class User {

    @ExcelColumn(header = "ID", order = 1)
    private Long id;

    @ExcelColumn(header = "å§“å", order = 2)
    private String name;

    @ExcelColumn(header = "Email", order = 3)
    private String email;

    @ExcelColumn(header = "å»ºç«‹æ™‚é–“", order = 4, format = "yyyy-MM-dd")
    private LocalDateTime createdAt;

    // getter / setter
}
```

ğŸ“Œ **å•†æ¥­æ¨¡å‹åªæ¨™è¨»è³‡æ–™ï¼Œä¸çŸ¥é“ Excel æ€éº¼ç”¢**

---

# å››ã€æ¬„ä½ Metadataï¼ˆTemplate ä½¿ç”¨ï¼‰

```java
public class ExcelColumnMeta {

    private String header;
    private int order;
    private Field field;
    private String format;

    // constructor / getter
}
```

---

# äº”ã€Sheet Metadataï¼ˆæ”¯æ´å¤š Sheetï¼‰

```java
public class ExcelSheetMeta<T> {

    private String sheetName;
    private List<T> data;
    private Class<T> type;
    private Set<String> enabledFields; // å‹•æ…‹æ¬„ä½

    // constructor / getter
}
```

---

# å…­ã€Annotation è§£æå™¨ï¼ˆæ ¸å¿ƒæŠ€è¡“ï¼‰

```java
public class ExcelMetaResolver {

    public static <T> List<ExcelColumnMeta> resolveColumns(
            Class<T> clazz,
            Set<String> enabledFields) {

        return Arrays.stream(clazz.getDeclaredFields())
            .filter(f -> f.isAnnotationPresent(ExcelColumn.class))
            .map(f -> {
                ExcelColumn ann = f.getAnnotation(ExcelColumn.class);
                f.setAccessible(true);
                return new ExcelColumnMeta(
                    ann.header(),
                    ann.order(),
                    f,
                    ann.format()
                );
            })
            .filter(m -> enabledFields == null ||
                         enabledFields.contains(m.getField().getName()))
            .sorted(Comparator.comparingInt(ExcelColumnMeta::getOrder))
            .toList();
    }
}
```

ğŸ“Œ **é€™è£¡æ±ºå®šã€Œå“ªäº›æ¬„ä½å‡ºç¾ã€**

---

# ä¸ƒã€ExcelExportTemplateï¼ˆä¼æ¥­ç´šæ¨¡æ¿ï¼‰

```java
public class ExcelExportTemplate {

    public Workbook export(List<ExcelSheetMeta<?>> sheets) {

        Workbook wb = new SXSSFWorkbook(100);
        CreationHelper helper = wb.getCreationHelper();

        for (ExcelSheetMeta<?> sheetMeta : sheets) {
            createSheet(wb, helper, sheetMeta);
        }

        return wb;
    }

    private <T> void createSheet(
            Workbook wb,
            CreationHelper helper,
            ExcelSheetMeta<T> sheetMeta) {

        Sheet sheet = wb.createSheet(sheetMeta.getSheetName());
        List<ExcelColumnMeta> columns =
            ExcelMetaResolver.resolveColumns(
                sheetMeta.getType(),
                sheetMeta.getEnabledFields()
            );

        // Header
        Row headerRow = sheet.createRow(0);
        for (int i = 0; i < columns.size(); i++) {
            headerRow.createCell(i)
                     .setCellValue(columns.get(i).getHeader());
        }

        // Data
        for (int i = 0; i < sheetMeta.getData().size(); i++) {
            Row row = sheet.createRow(i + 1);
            T data = sheetMeta.getData().get(i);

            for (int j = 0; j < columns.size(); j++) {
                writeCell(
                    wb, helper, row.createCell(j),
                    columns.get(j), data
                );
            }
        }
    }

    private <T> void writeCell(
            Workbook wb,
            CreationHelper helper,
            Cell cell,
            ExcelColumnMeta meta,
            T data) {

        try {
            Object value = meta.getField().get(data);

            if (value == null) return;

            if (value instanceof Number n) {
                cell.setCellValue(n.doubleValue());
            } else if (value instanceof LocalDateTime dt) {
                CellStyle style = wb.createCellStyle();
                style.setDataFormat(
                    helper.createDataFormat()
                          .getFormat(meta.getFormat())
                );
                cell.setCellValue(
                    Date.from(dt.atZone(ZoneId.systemDefault()).toInstant())
                );
                cell.setCellStyle(style);
            } else {
                cell.setCellValue(value.toString());
            }

        } catch (IllegalAccessException e) {
            throw new RuntimeException(e);
        }
    }
}
```

ğŸ“Œ **Template = åªç®¡æµç¨‹ï¼Œä¸ç®¡æ¥­å‹™**

---

# å…«ã€ExcelExportServiceï¼ˆå°å¤–å”¯ä¸€å…¥å£ï¼‰

```java
@Service
public class ExcelExportService {

    public void export(
            String fileName,
            List<ExcelSheetMeta<?>> sheets,
            HttpServletResponse response) throws IOException {

        ExcelExportTemplate template = new ExcelExportTemplate();
        Workbook wb = template.export(sheets);

        response.setContentType(
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setHeader(
            "Content-Disposition",
            "attachment; filename=\"" + fileName + "\"");

        try (wb; OutputStream os = response.getOutputStream()) {
            wb.write(os);
        }
    }
}
```

---

# ä¹ã€Controllerï¼šå¤š Sheet + å‹•æ…‹æ¬„ä½

```java
@GetMapping("/export")
public void export(HttpServletResponse response) throws IOException {

    List<User> users = userService.findAll();

    ExcelSheetMeta<User> userSheet =
        new ExcelSheetMeta<>(
            "ä½¿ç”¨è€…",
            users,
            User.class,
            Set.of("id", "name", "email") // å‹•æ…‹æ¬„ä½
        );

    excelExportService.export(
        "report.xlsx",
        List.of(userSheet),
        response
    );
}
```

ğŸ“Œ **æƒ³åŠ ç¬¬äºŒå¼µ Sheetï¼Ÿå†å¡ä¸€å€‹ `ExcelSheetMeta` å³å¯**

---

# åã€é€™å¥—è¨­è¨ˆçš„ã€Œç­‰ç´šã€

| èƒ½åŠ›            | ç‹€æ…‹    |
| ------------- | ----- |
| POI éš”é›¢        | âœ…     |
| Annotation é©…å‹• | âœ…     |
| å¤š Sheet       | âœ…     |
| å‹•æ…‹æ¬„ä½          | âœ…     |
| å¤§è³‡æ–™           | âœ…     |
| å¯æ“´å……           | â­â­â­â­â­ |

---

## ä¸‹ä¸€éšï¼ˆçœŸæ­£ä¼æ¥­ç³»çµ±æœƒåšçš„ï¼‰

* `@ExcelIgnore`
* æ¬„ä½å¯¬åº¦ç­–ç•¥
* æ¨£å¼ç­–ç•¥ï¼ˆHeader / Bodyï¼‰
* éåŒæ­¥ç”¢æª”ï¼ˆQueue / S3ï¼‰
* åŒ¯å‡ºæ¨¡æ¿ç‰ˆæœ¬æ§ç®¡

ä½ åªè¦èªªä¸€è²
ğŸ‘‰ã€Œ**æˆ‘è¦å†å¾€å“ªå€‹æ–¹å‘å‡ç´š**ã€
æˆ‘å¯ä»¥ç›´æ¥å¹«ä½ è£œæˆ **å…¬å¸ç´šæ¨™æº– Excel Framework**ã€‚
